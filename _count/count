#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# åˆå§‹åŒ–æ‰€æœ‰å˜é‡ï¼ˆæ ¸å¿ƒï¼šopt_l=1 å³å¼€å¯-lå‚æ•°ï¼Œæ˜¾ç¤ºlsç»“æœï¼‰
opt_show_raw=0  ; opt_count_col=0 ; opt_l=0
opt_only_file=0 ; opt_only_dir=0  ; opt_no_hidden=0
target_path="./"; hidden_note="å«éšè—"
file_count=0    ; dir_count=0     ; total_count=0
# å½©è‰²è¾“å‡ºï¼ˆæ–‡ä»¶å¤¹è“/æ–‡ä»¶ç»¿/æ€»æ•°çº¢ï¼Œç»ˆç«¯é€šç”¨ï¼Œå¯åˆ \033å…³é—­ï¼‰
color_dir="\033[34m"; color_file="\033[32m"; color_total="\033[31m"; color_reset="\033[0m"

# å¸®åŠ©ä¿¡æ¯ï¼ˆæ›´æ–°-lå‚æ•°è¯´æ˜ï¼Œç®€æ´æ¸…æ™°ï¼‰
show_help() {
    cat << EOF
ğŸ”§ ç”¨æ³•: count [é€‰é¡¹] [è·¯å¾„/é€šé…ç¬¦]  æˆ–  å‘½ä»¤ | count [é€‰é¡¹]
ğŸ“Œ æ ¸å¿ƒåŠŸèƒ½ï¼š1.ç®¡é“ç»Ÿè®¡è¡Œ/åˆ—  2.è·¯å¾„ç»Ÿè®¡ã€Œå†…éƒ¨ã€æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆ-læ˜¾lsç»“æœï¼‰
ğŸ’¡ é€šç”¨è§„åˆ™ï¼šå‚æ•°å¯ç»„åˆ(-ln=-l-n) | å‚æ•°ä¸è·¯å¾„å¯è°ƒæ¢ | è‡ªåŠ¨è·³è¿‡æ— æƒé™é¡¹

ã€ç®¡é“æ¨¡å¼ä¸“å±é€‰é¡¹ã€‘ï¼ˆä»…å‘½ä»¤|countæ—¶ç”Ÿæ•ˆï¼‰
  -v  æ˜¾ç¤ºåŸç”Ÿè¾“å‡ºï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨åº•éƒ¨
  -V  æ˜¾ç¤ºåŸç”Ÿè¾“å‡ºï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨é¡¶éƒ¨
  -c  ç»Ÿè®¡åˆ—æ•°ï¼ˆå¯ä¸-v/Vç»„åˆï¼ŒåŒæ—¶ç»Ÿè®¡è¡Œ+åˆ—ï¼‰

ã€è·¯å¾„æ¨¡å¼ä¸“å±é€‰é¡¹ã€‘ï¼ˆä»…count [é€‰é¡¹] è·¯å¾„æ—¶ç”Ÿæ•ˆï¼Œå¯ç»„åˆï¼‰
  -f  ä»…ç»Ÿè®¡æ–‡ä»¶ï¼ˆä¸åŒ…å«æ–‡ä»¶å¤¹ï¼‰
  -d  ä»…ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆä¸åŒ…å«æ–‡ä»¶ï¼‰
  -n  è¿‡æ»¤éšè—é¡¹ï¼ˆåç§°ä»¥.å¼€å¤´çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼‰
  -l  è¾“å‡ºlsåŸç”Ÿç»“æœï¼Œæœ«å°¾æ˜¾ç¤ºæ–‡ä»¶å¤¹/æ–‡ä»¶/æ€»æ•°ç»Ÿè®¡ã€æ ¸å¿ƒç®€åŒ–ã€‘

ã€é€šç”¨é€‰é¡¹ã€‘
  -h/--help  æ˜¾ç¤ºæœ¬å¸®åŠ©ä¿¡æ¯

ğŸ“ å¸¸ç”¨ç¤ºä¾‹
  ç®¡é“æ¨¡å¼ï¼šll | count        # ä»…ç»Ÿè®¡llè¾“å‡ºè¡Œæ•°
            ll | count -Vc    # é¡¶éƒ¨ç»Ÿè®¡è¡Œ+åˆ—ï¼Œåæ˜¾åŸç”Ÿå†…å®¹
  è·¯å¾„æ¨¡å¼ï¼šcount /home/jim   # ä»…ç»Ÿè®¡jimç›®å½•å†…æ–‡ä»¶+æ–‡ä»¶å¤¹
            count -l /home/jim # è¾“å‡ºlsç»“æœ+æœ«å°¾ç»Ÿè®¡ï¼ˆæ ¸å¿ƒç®€åŒ–ï¼‰
            count -ln ~/     # è¾“å‡ºééšè—é¡¹lsç»“æœ+ç»Ÿè®¡
            count -lf ./ShellKit # è¾“å‡ºä»…æ–‡ä»¶çš„lsç»“æœ+ç»Ÿè®¡
            count *.sh -l     # é€šé…ç¬¦+lsç»“æœ+ç»Ÿè®¡
EOF
    exit 0
}

# è§£æå‚æ•°ï¼ˆæ ¸å¿ƒï¼šç®€åŒ–ä¸º-lå•å­—ç¬¦ï¼Œæ”¯æŒç»„åˆå¦‚-ln/-lfï¼Œå¿½ç•¥ç®¡é“ä¸“å±å‚æ•°ï¼‰
parse_args() {
    local path_candidate=""
    for arg in "$@"; do
        if [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then show_help; fi
        # åŒ¹é…-å¼€å¤´çš„é€‰é¡¹
        if [ "${arg:0:1}" = "-" ]; then
            if [ "${arg:1:1}" = "--" ]; then
                # é•¿é€‰é¡¹å…¼å®¹ï¼ˆå¿½ç•¥ç®¡é“é•¿é€‰é¡¹ï¼Œä»…å¤„ç†è·¯å¾„é€‰é¡¹ï¼‰
                local opt=${arg#--}
                case "$opt" in
                    verbose|VERBOSE|col) : ;;
                    file) opt_only_file=1 ;;
                    dir) opt_only_dir=1 ;;
                    no-hidden) opt_no_hidden=1; hidden_note="ééšè—" ;;
                    *) echo "âŒ é”™è¯¯ï¼šæœªçŸ¥é•¿é€‰é¡¹ $arg" >&2; show_help ;;
                esac
            else
                # çŸ­é€‰é¡¹ï¼ˆæ”¯æŒç»„åˆï¼Œæ ¸å¿ƒç®€åŒ–ä¸º-lï¼Œå¿½ç•¥-v/V/cï¼‰
                local opt_chars=${arg#-}
                local len=${#opt_chars}
                for ((i=0; i<len; i++)); do
                    local c=${opt_chars:$i:1}
                    case "$c" in
                        v|V|c) : ;; # è·¯å¾„æ¨¡å¼å¿½ç•¥ç®¡é“ä¸“å±å‚æ•°ï¼Œä¸æŠ¥é”™
                        f) opt_only_file=1 ;;
                        d) opt_only_dir=1 ;;
                        n) opt_no_hidden=1; hidden_note="ééšè—" ;;
                        l) opt_l=1 ;; # æ ¸å¿ƒï¼šå•å­—ç¬¦-lï¼Œå¼€å¯lsç»“æœè¾“å‡º
                        h) show_help ;;
                        *) echo "âŒ é”™è¯¯ï¼šæœªçŸ¥çŸ­é€‰é¡¹ -$c" >&2; show_help ;;
                    esac
                done
            fi
        else
            path_candidate="$arg" # æå–è·¯å¾„ï¼ˆå¤šä¸ªå–æœ€åä¸€ä¸ªï¼Œæ”¯æŒè°ƒæ¢ï¼‰
        fi
    done
    # èµ‹å€¼ç›®æ ‡è·¯å¾„ï¼Œæ— æŒ‡å®šåˆ™é»˜è®¤å½“å‰ç›®å½•
    [ -n "$path_candidate" ] && target_path="$path_candidate"
    # äº’æ–¥æ£€æŸ¥ï¼š-få’Œ-dä¸èƒ½åŒæ—¶ä½¿ç”¨
    if [ $opt_only_file -eq 1 ] && [ $opt_only_dir -eq 1 ]; then
        echo "âŒ é”™è¯¯ï¼š-f(ä»…æ–‡ä»¶) å’Œ -d(ä»…æ–‡ä»¶å¤¹) ä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼" >&2
        exit 1
    fi
}

# ç®¡é“æ¨¡å¼å¤„ç†ï¼ˆåŸæœ‰åŠŸèƒ½å®Œå…¨ä¸å˜ï¼Œ-v/-V/cæ­£å¸¸ç”Ÿæ•ˆï¼‰
handle_pipe() {
    if [ ! -t 0 ]; then
        pipe_input=$(cat - 2>/dev/null) || true
        line_count=$(echo "$pipe_input" | wc -l | tr -d ' \t\n\r')
        col_count=0
        # ç»Ÿè®¡åˆ—æ•°ï¼ˆå–ç¬¬ä¸€è¡ŒæŒ‰ç©ºç™½åˆ†å‰²ï¼Œå…¼å®¹ls/ll/psç­‰å‘½ä»¤ï¼‰
        if [ $opt_count_col -eq 1 ] && [ -n "$pipe_input" ]; then
            first_line=$(echo "$pipe_input" | head -n1 | xargs 2>/dev/null) || true
            col_count=$(echo "$first_line" | wc -w | tr -d ' \t\n\r')
        fi
        # æŒ‰-v/Vè§„åˆ™è¾“å‡ºåŸç”Ÿå†…å®¹+ç»Ÿè®¡
        if [ $opt_show_raw -eq 2 ]; then
            echo -e "=== ç»Ÿè®¡ç»“æœ ==="
            echo "æ€»è¡Œæ•°: $line_count" && [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
            echo -e "=== åŸç”Ÿè¾“å‡º ===" && echo "$pipe_input"
        elif [ $opt_show_raw -eq 1 ]; then
            echo -e "=== åŸç”Ÿè¾“å‡º ===" && echo "$pipe_input"
            echo -e "=== ç»Ÿè®¡ç»“æœ ==="
            echo "æ€»è¡Œæ•°: $line_count" && [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
        else
            echo "æ€»è¡Œæ•°: $line_count" && [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
        fi
        exit 0
    fi
}

# å­é¡¹ç»Ÿè®¡å‡½æ•°ï¼ˆå«æ€»æ•°ç´¯åŠ ï¼Œè¿‡æ»¤éšè—é¡¹é€»è¾‘ï¼‰
count_sub_item() {
    local sub=$1
    # è¿‡æ»¤éšè—é¡¹ï¼š-nç”Ÿæ•ˆæ—¶ï¼Œè·³è¿‡ä»¥.å¼€å¤´çš„æ–‡ä»¶/æ–‡ä»¶å¤¹
    if [ $opt_no_hidden -eq 1 ]; then
        local sub_name=$(basename "$sub" 2>/dev/null) || true
        [ "${sub_name:0:1}" = "." ] && return
    fi
    # ç»Ÿè®¡æ–‡ä»¶ï¼ˆæ™®é€šæ–‡ä»¶+è½¯é“¾æ¥ï¼‰ï¼Œç´¯åŠ æ€»æ•°
    if [ -f "$sub" ] 2>/dev/null || [ -L "$sub" ] 2>/dev/null; then
        file_count=$((file_count + 1))
        total_count=$((total_count + 1))
    # ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆçœŸå®ç›®å½•ï¼Œæ’é™¤è½¯é“¾æ¥ï¼‰ï¼Œç´¯åŠ æ€»æ•°
    elif [ -d "$sub" ] 2>/dev/null && [ ! -L "$sub" ] 2>/dev/null; then
        dir_count=$((dir_count + 1))
        total_count=$((total_count + 1))
    fi
}

# è·¯å¾„æ¨¡å¼å¤„ç†ï¼ˆæ ¸å¿ƒï¼š-lå‚æ•°è¾“å‡ºlsåŸç”Ÿç»“æœï¼Œåæ˜¾ç»Ÿè®¡ï¼‰
handle_path() {
    local items=()
    # é€šé…ç¬¦å¤„ç†ï¼šå¼€å¯nullglobé¿å…æ— åŒ¹é…æ—¶è¿”å›åŸå­—ç¬¦ä¸²
    shopt -s nullglob globstar
    eval "items=($target_path)" 2>/dev/null || true
    shopt -u nullglob globstar

    # æ— åŒ¹é…é¡¹å‹å¥½æç¤º
    if [ ${#items[@]} -eq 0 ]; then
        echo -e "âš ï¸  æç¤ºï¼šè·¯å¾„/é€šé…ç¬¦ '$target_path' æ— åŒ¹é…é¡¹æˆ–æ— è®¿é—®æƒé™"
        exit 0
    fi

    # æ ¸å¿ƒï¼š-lå‚æ•°ç”Ÿæ•ˆæ—¶ï¼Œå…ˆè¾“å‡ºlsåŸç”Ÿç»“æœï¼ˆå…¼å®¹-nè¿‡æ»¤éšè—ï¼‰
    if [ $opt_l -eq 1 ]; then
        echo -e "ğŸ“‹ $hidden_noteé¡¹ ls åŸç”Ÿç»“æœï¼š\n"
        # è¿‡æ»¤éšè—é¡¹æ—¶ï¼Œlsç”¨--hide='.*'åªæ˜¾ç¤ºééšè—å†…å®¹ï¼Œå’Œç»Ÿè®¡é€»è¾‘ä¸€è‡´
        if [ $opt_no_hidden -eq 1 ]; then
            ls --hide='.*' "$target_path" 2>/dev/null || echo "âš ï¸  æç¤ºï¼šæ— æƒé™æŸ¥çœ‹ $target_path çš„lsç»“æœ"
        else
            ls "$target_path" 2>/dev/null || echo "âš ï¸  æç¤ºï¼šæ— æƒé™æŸ¥çœ‹ $target_path çš„lsç»“æœ"
        fi
        echo -e "\n========================================" # åˆ†éš”çº¿ï¼ŒåŒºåˆ†lså’Œç»Ÿè®¡
    fi

    # éå†åŒ¹é…é¡¹ï¼šç›®å½•ç»Ÿè®¡ã€Œå†…éƒ¨ã€å­é¡¹ï¼Œæ–‡ä»¶/é€šé…ç¬¦ç›´æ¥ç»Ÿè®¡
    for item in "${items[@]}"; do
        # è·³è¿‡ä¸å­˜åœ¨/æ— æƒé™çš„é¡¹
        if [ ! -e "$item" ] && [ ! -L "$item" ]; then continue; fi
        # æ˜¯ç›®å½•åˆ™éå†å†…éƒ¨æ‰€æœ‰å­é¡¹ï¼Œéç›®å½•ç›´æ¥ç»Ÿè®¡
        if [ -d "$item" ] 2>/dev/null && [ ! -L "$item" ] 2>/dev/null; then
            local sub_items=()
            shopt -s nullglob globstar
            sub_items=("$item"/*)
            shopt -u nullglob globstar
            # é€’å½’ç»Ÿè®¡ç›®å½•å†…å­é¡¹
            for sub in "${sub_items[@]}"; do
                count_sub_item "$sub"
            done
        else
            # éç›®å½•ï¼ˆæ–‡ä»¶/è½¯é“¾æ¥/é€šé…ç¬¦ï¼‰ç›´æ¥ç»Ÿè®¡
            count_sub_item "$item"
        fi
    done

    # è¾“å‡ºç»Ÿè®¡ç»“æœï¼ˆå«æ–‡ä»¶å¤¹/æ–‡ä»¶/æ€»æ•°ï¼Œå½©è‰²é«˜äº®ï¼‰
    if [ $opt_only_file -eq 1 ]; then
        echo -e "ğŸ“„ ä»…ç»Ÿè®¡æ–‡ä»¶ï¼ˆ$hidden_noteï¼‰: ${color_file}$file_count${color_reset} ä¸ª"
        echo -e "ğŸ“ ç»Ÿè®¡è·¯å¾„: $target_path"
    elif [ $opt_only_dir -eq 1 ]; then
        echo -e "ğŸ“‚ ä»…ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆ$hidden_noteï¼‰: ${color_dir}$dir_count${color_reset} ä¸ª"
        echo -e "ğŸ“ ç»Ÿè®¡è·¯å¾„: $target_path"
    else
        echo -e "ğŸ“Š ç»Ÿè®¡ç»“æœï¼ˆ$hidden_noteï¼‰| è·¯å¾„: $target_path"
        echo -e "â”œâ”€ ğŸ“‚ æ–‡ä»¶å¤¹: ${color_dir}$dir_count${color_reset} ä¸ª"
        echo -e "â”œâ”€ ğŸ“„ æ–‡ä»¶: ${color_file}$file_count${color_reset} ä¸ª"
        echo -e "â””â”€ ğŸ§® æ€»æ•°: ${color_total}$total_count${color_reset} ä¸ª"
    fi

    # è®¡æ•°ä¸º0çš„å…œåº•æç¤º
    if [ $file_count -eq 0 ] && [ $dir_count -eq 0 ]; then
        echo -e "\nâš ï¸  æç¤ºï¼šæ— ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæˆ–æ— è®¿é—®æƒé™ï¼‰"
    fi
}

# ä¸»é€»è¾‘ï¼ˆä¼˜å…ˆç®¡é“æ¨¡å¼ï¼Œåè·¯å¾„æ¨¡å¼ï¼Œå…œåº•æŠ¥é”™ï¼‰
main() {
    parse_args "$@" 2>/dev/null || true
    handle_pipe
    handle_path
}

# æ‰§è¡Œä¸»é€»è¾‘ï¼Œæ•è·æ‰€æœ‰é¡¶å±‚æŠ¥é”™
main "$@" 2>/dev/null || {
    echo -e "âŒ æ‰§è¡Œé”™è¯¯ï¼è¯·è¿è¡Œ \`$0 -h\` æŸ¥çœ‹æ­£ç¡®ç”¨æ³•"
    exit 1
}
