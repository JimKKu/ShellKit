#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# åˆå§‹åŒ–æ‰€æœ‰å˜é‡ï¼ˆæ˜¾å¼èµ‹å€¼ï¼Œé¿å…set -uæŠ¥é”™ï¼‰
opt_show_raw=0  ; opt_count_col=0
opt_only_file=0 ; opt_only_dir=0 ; opt_no_hidden=0
target_path="./"; hidden_note="å«éšè—"
file_count=0    ; dir_count=0
# å½©è‰²è¾“å‡ºï¼ˆç»ˆç«¯é€šç”¨ï¼Œä¸å–œæ¬¢å¯åˆ é™¤æ‰€æœ‰\033ç›¸å…³å­—ç¬¦ï¼‰
color_dir="\033[34m"; color_file="\033[32m"; color_reset="\033[0m"

# å¸®åŠ©ä¿¡æ¯ï¼ˆç²¾ç®€æ¸…æ™°ï¼Œæ ‡æ³¨å‚æ•°é€‚ç”¨æ¨¡å¼ï¼‰
show_help() {
    cat << EOF
ğŸ”§ ç”¨æ³•: count [é€‰é¡¹] [è·¯å¾„/é€šé…ç¬¦]  æˆ–  å‘½ä»¤ | count [é€‰é¡¹]
ğŸ“Œ æ ¸å¿ƒåŠŸèƒ½ï¼š1.ç®¡é“ç»Ÿè®¡è¡Œ/åˆ—  2.è·¯å¾„ç»Ÿè®¡ã€Œå†…éƒ¨ã€æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæ”¯æŒé€šé…ç¬¦ï¼‰
ğŸ’¡ é€šç”¨è§„åˆ™ï¼šå‚æ•°å¯ç»„åˆ(-fn=-f-n) | å‚æ•°ä¸è·¯å¾„å¯è°ƒæ¢ | è‡ªåŠ¨è·³è¿‡æ— æƒé™é¡¹

ã€ç®¡é“æ¨¡å¼ä¸“å±é€‰é¡¹ã€‘ï¼ˆä»…å‘½ä»¤|countæ—¶ç”Ÿæ•ˆï¼‰
  -v  æ˜¾ç¤ºåŸç”Ÿè¾“å‡ºï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨åº•éƒ¨
  -V  æ˜¾ç¤ºåŸç”Ÿè¾“å‡ºï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨é¡¶éƒ¨
  -c  ç»Ÿè®¡åˆ—æ•°ï¼ˆå¯ä¸-v/Vç»„åˆï¼ŒåŒæ—¶ç»Ÿè®¡è¡Œ+åˆ—ï¼‰

ã€è·¯å¾„æ¨¡å¼ä¸“å±é€‰é¡¹ã€‘ï¼ˆä»…count [é€‰é¡¹] è·¯å¾„æ—¶ç”Ÿæ•ˆï¼‰
  -f  ä»…ç»Ÿè®¡æ–‡ä»¶ï¼ˆä¸åŒ…å«æ–‡ä»¶å¤¹ï¼‰
  -d  ä»…ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆä¸åŒ…å«æ–‡ä»¶ï¼‰
  -n  è¿‡æ»¤éšè—é¡¹ï¼ˆåç§°ä»¥.å¼€å¤´çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼‰

ã€é€šç”¨é€‰é¡¹ã€‘
  -h/--help  æ˜¾ç¤ºæœ¬å¸®åŠ©ä¿¡æ¯

ğŸ“ å¸¸ç”¨ç¤ºä¾‹
  ç®¡é“æ¨¡å¼ï¼šll | count        # ä»…ç»Ÿè®¡llè¾“å‡ºè¡Œæ•°
            ll | count -Vc    # é¡¶éƒ¨ç»Ÿè®¡è¡Œ+åˆ—ï¼Œåæ˜¾åŸç”Ÿå†…å®¹
            ps aux | count -c # ä»…ç»Ÿè®¡psè¾“å‡ºåˆ—æ•°
  è·¯å¾„æ¨¡å¼ï¼šcount /home/jim   # ç»Ÿè®¡jimç›®å½•ã€Œå†…éƒ¨ã€æ‰€æœ‰æ–‡ä»¶+æ–‡ä»¶å¤¹
            count -fn ~/      # ç»Ÿè®¡å®¶ç›®å½•ã€Œå†…éƒ¨ã€ééšè—æ–‡ä»¶
            count ~/*.py      # ç»Ÿè®¡å®¶ç›®å½•ä¸‹æ‰€æœ‰.pyåç¼€æ–‡ä»¶
            count -dn ./DevCodes # ç»Ÿè®¡DevCodeså†…ééšè—æ–‡ä»¶å¤¹
EOF
    exit 0
}

# è§£æå‚æ•°ï¼ˆæ ¸å¿ƒï¼šåˆ†ç¦»ç®¡é“/è·¯å¾„å‚æ•°ï¼Œè·¯å¾„æ¨¡å¼å¿½ç•¥-v/V/cï¼‰
parse_args() {
    local path_candidate=""
    for arg in "$@"; do
        if [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then show_help; fi
        # åŒ¹é…é€‰é¡¹ï¼ˆ-å¼€å¤´ï¼‰
        if [ "${arg:0:1}" = "-" ]; then
            if [ "${arg:1:1}" = "-" ]; then
                # é•¿é€‰é¡¹ï¼ˆä»…åšå…¼å®¹ï¼Œæ¨èç”¨çŸ­é€‰é¡¹ï¼‰
                local opt=${arg#--}
                case "$opt" in
                    verbose|VERBOSE|col) : ;; # è·¯å¾„æ¨¡å¼å¿½ç•¥ç®¡é“é•¿é€‰é¡¹
                    file) opt_only_file=1 ;;
                    dir) opt_only_dir=1 ;;
                    no-hidden) opt_no_hidden=1; hidden_note="ééšè—" ;;
                    *) echo "é”™è¯¯ï¼šæœªçŸ¥é•¿é€‰é¡¹ $arg" >&2; show_help ;;
                esac
            else
                # çŸ­é€‰é¡¹ï¼ˆæ”¯æŒç»„åˆï¼Œè·¯å¾„æ¨¡å¼è‡ªåŠ¨å¿½ç•¥-v/V/cï¼‰
                local opt_chars=${arg#-}
                local len=${#opt_chars}
                for ((i=0; i<len; i++)); do
                    local c=${opt_chars:$i:1}
                    case "$c" in
                        v|V|c) : ;; # å…³é”®ï¼šè·¯å¾„æ¨¡å¼å¿½ç•¥ç®¡é“ä¸“å±çŸ­é€‰é¡¹ï¼Œæ— ä»»ä½•æç¤º
                        f) opt_only_file=1 ;;
                        d) opt_only_dir=1 ;;
                        n) opt_no_hidden=1; hidden_note="ééšè—" ;;
                        h) show_help ;;
                        *) echo "é”™è¯¯ï¼šæœªçŸ¥çŸ­é€‰é¡¹ -$c" >&2; show_help ;;
                    esac
                done
            fi
        else
            path_candidate="$arg" # æå–è·¯å¾„ï¼ˆå¤šä¸ªå–æœ€åä¸€ä¸ªï¼‰
        fi
    done
    # èµ‹å€¼ç›®æ ‡è·¯å¾„ï¼šæœ‰æŒ‡å®šåˆ™ç”¨ï¼Œæ— åˆ™é»˜è®¤å½“å‰ç›®å½•
    [ -n "$path_candidate" ] && target_path="$path_candidate"
    # äº’æ–¥æ£€æŸ¥ï¼š-få’Œ-dä¸èƒ½åŒæ—¶ç”¨
    if [ $opt_only_file -eq 1 ] && [ $opt_only_dir -eq 1 ]; then
        echo "âŒ é”™è¯¯ï¼š-f(ä»…æ–‡ä»¶) å’Œ -d(ä»…æ–‡ä»¶å¤¹) ä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼" >&2
        exit 1
    fi
}

# ç®¡é“æ¨¡å¼å¤„ç†ï¼ˆä»…å‘½ä»¤|countæ—¶ç”Ÿæ•ˆï¼Œ-v/-V/cæ­£å¸¸å·¥ä½œï¼‰
handle_pipe() {
    if [ ! -t 0 ]; then
        pipe_input=$(cat - 2>/dev/null) || true
        line_count=$(echo "$pipe_input" | wc -l | tr -d ' \t\n\r')
        col_count=0
        # ç»Ÿè®¡åˆ—æ•°ï¼ˆå–ç¬¬ä¸€è¡ŒæŒ‰ç©ºç™½åˆ†å‰²ï¼Œå…¼å®¹ls/ll/psç­‰ï¼‰
        if [ $opt_count_col -eq 1 ] && [ -n "$pipe_input" ]; then
            first_line=$(echo "$pipe_input" | head -n1 | xargs 2>/dev/null) || true
            col_count=$(echo "$first_line" | wc -w | tr -d ' \t\n\r')
        fi
        # æŒ‰-v/Vè§„åˆ™è¾“å‡ºåŸç”Ÿå†…å®¹+ç»Ÿè®¡
        if [ $opt_show_raw -eq 2 ]; then
            echo -e "=== ç»Ÿè®¡ç»“æœ ==="
            echo "æ€»è¡Œæ•°: $line_count" && [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
            echo -e "=== åŸç”Ÿè¾“å‡º ===" && echo "$pipe_input"
        elif [ $opt_show_raw -eq 1 ]; then
            echo -e "=== åŸç”Ÿè¾“å‡º ===" && echo "$pipe_input"
            echo -e "=== ç»Ÿè®¡ç»“æœ ==="
            echo "æ€»è¡Œæ•°: $line_count" && [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
        else
            echo "æ€»è¡Œæ•°: $line_count" && [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
        fi
        exit 0
    fi
}

# è·¯å¾„æ¨¡å¼å¤„ç†ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šç»Ÿè®¡ç›®å½•ã€Œå†…éƒ¨ã€å­é¡¹ï¼Œé€šé…ç¬¦æ­£å¸¸åŒ¹é…ï¼‰
handle_path() {
    local items=()
    # å¤„ç†é€šé…ç¬¦/è·¯å¾„ï¼šå¼€å¯nullglobé¿å…æ— åŒ¹é…æ—¶è¿”å›åŸå­—ç¬¦ä¸²
    shopt -s nullglob globstar
    eval "items=($target_path)" 2>/dev/null || true
    shopt -u nullglob globstar

    # æ— åŒ¹é…é¡¹æç¤º
    if [ ${#items[@]} -eq 0 ]; then
        echo -e "âš ï¸  æç¤ºï¼šè·¯å¾„/é€šé…ç¬¦ '$target_path' æ— åŒ¹é…é¡¹æˆ–æ— è®¿é—®æƒé™"
        exit 0
    fi

    # éå†åŒ¹é…é¡¹ï¼šå¦‚æœæ˜¯ç›®å½•ï¼Œç»Ÿè®¡ã€Œå†…éƒ¨ã€å­é¡¹ï¼›å¦‚æœæ˜¯æ–‡ä»¶/é€šé…ç¬¦ï¼Œç›´æ¥ç»Ÿè®¡
    for item in "${items[@]}"; do
        # è·³è¿‡ä¸å­˜åœ¨/æ— æƒé™çš„é¡¹
        if [ ! -e "$item" ] && [ ! -L "$item" ]; then continue; fi
        # æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæ˜¯ç›®å½•ï¼Œéå†å…¶**å†…éƒ¨**çš„æ‰€æœ‰å­é¡¹ï¼ˆ*/ åŒ¹é…ç›®å½•å†…æ‰€æœ‰é¡¹ï¼‰
        if [ -d "$item" ] 2>/dev/null && [ ! -L "$item" ] 2>/dev/null; then
            local sub_items=()
            shopt -s nullglob globstar
            sub_items=("$item"/*) # åŒ¹é…ç›®å½•å†…æ‰€æœ‰å­é¡¹ï¼ˆä¸å«éšè—ï¼Œåç»­è¿‡æ»¤ï¼‰
            shopt -u nullglob globstar
            # éå†ç›®å½•å†…å­é¡¹ï¼Œé€’å½’ç»Ÿè®¡
            for sub in "${sub_items[@]}"; do
                count_sub_item "$sub"
            done
        else
            # ä¸æ˜¯ç›®å½•ï¼ˆæ–‡ä»¶/è½¯é“¾æ¥/é€šé…ç¬¦åŒ¹é…é¡¹ï¼‰ï¼Œç›´æ¥ç»Ÿè®¡
            count_sub_item "$item"
        fi
    done

    # è¾“å‡ºç»Ÿè®¡ç»“æœï¼ˆå½©è‰²+æ¸…æ™°æ ¼å¼ï¼‰
    if [ $opt_only_file -eq 1 ]; then
        echo -e "ğŸ“„ ä»…ç»Ÿè®¡æ–‡ä»¶ï¼ˆ$hidden_noteï¼‰: ${color_file}$file_count${color_reset} ä¸ª"
        echo -e "ğŸ“ ç»Ÿè®¡è·¯å¾„: $target_path"
    elif [ $opt_only_dir -eq 1 ]; then
        echo -e "ğŸ“‚ ä»…ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆ$hidden_noteï¼‰: ${color_dir}$dir_count${color_reset} ä¸ª"
        echo -e "ğŸ“ ç»Ÿè®¡è·¯å¾„: $target_path"
    else
        echo -e "ğŸ“Š ç»Ÿè®¡ç»“æœï¼ˆ$hidden_noteï¼‰| è·¯å¾„: $target_path"
        echo -e "â”œâ”€ ğŸ“‚ æ–‡ä»¶å¤¹: ${color_dir}$dir_count${color_reset} ä¸ª"
        echo -e "â””â”€ ğŸ“„ æ–‡ä»¶: ${color_file}$file_count${color_reset} ä¸ª"
    fi
    # è®¡æ•°ä¸º0çš„å‹å¥½æç¤º
    if [ $file_count -eq 0 ] && [ $dir_count -eq 0 ]; then
        echo -e "âš ï¸  æç¤ºï¼šæ— ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæˆ–æ— è®¿é—®æƒé™ï¼‰"
    fi
}

# å­é¡¹ç»Ÿè®¡å‡½æ•°ï¼ˆæŠ½ç¦»å…¬å…±é€»è¾‘ï¼Œé¿å…é‡å¤ä»£ç ï¼Œæ”¯æŒè¿‡æ»¤éšè—ï¼‰
count_sub_item() {
    local sub=$1
    # è¿‡æ»¤éšè—é¡¹ï¼ˆ-nç”Ÿæ•ˆæ—¶ï¼Œè·³è¿‡åç§°ä»¥.å¼€å¤´çš„é¡¹ï¼‰
    if [ $opt_no_hidden -eq 1 ]; then
        local sub_name=$(basename "$sub" 2>/dev/null) || true
        [ "${sub_name:0:1}" = "." ] && return
    fi
    # ç»Ÿè®¡æ–‡ä»¶ï¼ˆæ™®é€šæ–‡ä»¶+è½¯é“¾æ¥ï¼Œå±è”½æƒé™æŠ¥é”™ï¼‰
    if [ -f "$sub" ] 2>/dev/null || [ -L "$sub" ] 2>/dev/null; then
        file_count=$((file_count + 1))
    # ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆçœŸå®ç›®å½•ï¼Œæ’é™¤è½¯é“¾æ¥ç›®å½•ï¼Œå±è”½æƒé™æŠ¥é”™ï¼‰
    elif [ -d "$sub" ] 2>/dev/null && [ ! -L "$sub" ] 2>/dev/null; then
        dir_count=$((dir_count + 1))
    fi
}

# ä¸»é€»è¾‘ï¼ˆå…œåº•æŠ¥é”™ï¼Œç¡®ä¿æ‰€æœ‰åœºæ™¯æœ‰è¾“å‡ºï¼‰
main() {
    parse_args "$@" 2>/dev/null || true
    handle_pipe # ä¼˜å…ˆç®¡é“æ¨¡å¼
    handle_path # æ— ç®¡é“åˆ™è·¯å¾„æ¨¡å¼
}

# æ‰§è¡Œä¸»é€»è¾‘ï¼Œæ•è·æ‰€æœ‰é¡¶å±‚æŠ¥é”™
main "$@" 2>/dev/null || {
    echo -e "âŒ æ‰§è¡Œé”™è¯¯ï¼è¯·è¿è¡Œ \`$0 -h\` æŸ¥çœ‹æ­£ç¡®ç”¨æ³•"
    exit 1
}
