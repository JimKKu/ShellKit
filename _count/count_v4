#!/bin/bash
# ä¿ç•™ä¸¥æ ¼æ¨¡å¼ï¼ŒåŒæ—¶ç”¨æ ‡å‡†è¯­æ³•é¿å…å…¼å®¹é—®é¢˜
set -euo pipefail
IFS=$'\n\t'

# åˆå§‹åŒ–æ‰€æœ‰å˜é‡ï¼ˆæ˜¾å¼èµ‹å€¼ï¼Œé¿å…set -uæŠ¥é”™ï¼‰
opt_show_raw=0
opt_count_col=0
opt_only_file=0
opt_only_dir=0
opt_no_hidden=0
target_path="./"
pipe_input=""
hidden_note="å«éšè—"
file_count=0
dir_count=0
color_dir="\033[34m"
color_file="\033[32m"
color_reset="\033[0m"

# å¸®åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
ç”¨æ³•: count [é€‰é¡¹] [è·¯å¾„/é€šé…ç¬¦]  æˆ–  å‘½ä»¤ | count [é€‰é¡¹]
åŠŸèƒ½: ç®¡é“ç»Ÿè®¡è¡Œ/åˆ— | è·¯å¾„ç»Ÿè®¡æ–‡ä»¶/æ–‡ä»¶å¤¹ | å…¼å®¹å‚æ•°ç»„åˆ/é€šé…ç¬¦/éšè—è¿‡æ»¤
é€‰é¡¹ï¼š
  ç®¡é“æ¨¡å¼ï¼š-v(åº•éƒ¨æ˜¾åŸç”Ÿ) -V(é¡¶éƒ¨æ˜¾åŸç”Ÿ) -c(ç»Ÿè®¡åˆ—)
  è·¯å¾„æ¨¡å¼ï¼š-f(ä»…æ–‡ä»¶) -d(ä»…æ–‡ä»¶å¤¹) -n(è¿‡æ»¤éšè—)
  é€šç”¨ï¼š-h/--help(å¸®åŠ©)ï¼Œå‚æ•°å¯ç»„åˆ(-fn=-f-n)ï¼Œå‚æ•°ä¸è·¯å¾„å¯è°ƒæ¢
ç¤ºä¾‹ï¼š
  ll | count -Vc  # é¡¶éƒ¨ç»Ÿè®¡è¡Œ+åˆ—ï¼Œå†æ˜¾llåŸç”Ÿå†…å®¹
  count -fn /home/jim  # ç»Ÿè®¡å®¶ç›®å½•ééšè—æ–‡ä»¶
  count ~/*.py    # ç»Ÿè®¡å®¶ç›®å½•pyæ–‡ä»¶
EOF
    exit 0
}

# è§£æå‚æ•°ï¼ˆæ ‡å‡†è¯­æ³•ï¼Œæ— å…¼å®¹é—®é¢˜ï¼‰
parse_args() {
    local path_candidate=""
    for arg in "$@"; do
        if [ "$arg" = "--help" ] || [ "$arg" = "-h" ]; then
            show_help
        elif [ "${arg:0:1}" = "-" ]; then
            if [ "${arg:1:1}" = "-" ]; then
                # é•¿é€‰é¡¹
                local opt=${arg#--}
                case "$opt" in
                    verbose) opt_show_raw=1 ;;
                    VERBOSE) opt_show_raw=2 ;;
                    col) opt_count_col=1 ;;
                    file) opt_only_file=1 ;;
                    dir) opt_only_dir=1 ;;
                    no-hidden) opt_no_hidden=1; hidden_note="ééšè—" ;;
                    *) echo "é”™è¯¯ï¼šæœªçŸ¥é•¿é€‰é¡¹ $arg" >&2; show_help ;;
                esac
            else
                # çŸ­é€‰é¡¹ï¼ˆæ”¯æŒç»„åˆï¼Œæ ‡å‡†forå¾ªç¯ï¼‰
                local opt_chars=${arg#-}
                local len=${#opt_chars}
                for ((i=0; i<len; i++)); do
                    local c=${opt_chars:$i:1}
                    case "$c" in
                        v) opt_show_raw=1 ;;
                        V) opt_show_raw=2 ;;
                        c) opt_count_col=1 ;;
                        f) opt_only_file=1 ;;
                        d) opt_only_dir=1 ;;
                        n) opt_no_hidden=1; hidden_note="ééšè—" ;;
                        h) show_help ;;
                        *) echo "é”™è¯¯ï¼šæœªçŸ¥çŸ­é€‰é¡¹ -$c" >&2; show_help ;;
                    esac
                done
            fi
        else
            path_candidate="$arg"
        fi
    done
    # èµ‹å€¼ç›®æ ‡è·¯å¾„ï¼Œæœ‰æŒ‡å®šåˆ™ç”¨ï¼Œæ— åˆ™é»˜è®¤å½“å‰ç›®å½•
    if [ -n "$path_candidate" ]; then
        target_path="$path_candidate"
    fi
    # äº’æ–¥æ£€æŸ¥
    if [ $opt_only_file -eq 1 ] && [ $opt_only_dir -eq 1 ]; then
        echo "é”™è¯¯ï¼š-få’Œ-dä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼" >&2
        exit 1
    fi
}

# ç®¡é“æ¨¡å¼å¤„ç†ï¼ˆæ ‡å‡†è¯­æ³•ï¼Œæ— è¯­æ³•é”™ï¼‰
handle_pipe() {
    if [ ! -t 0 ]; then
        # è¯»å–ç®¡é“è¾“å…¥ï¼Œå±è”½æŠ¥é”™
        pipe_input=$(cat - 2>/dev/null) || true
        # ç»Ÿè®¡è¡Œæ•°ï¼Œæ ‡å‡†è¯­æ³•å»ç©ºæ ¼
        line_count=$(echo "$pipe_input" | wc -l | tr -d ' \t\n\r')
        col_count=0
        # ç»Ÿè®¡åˆ—æ•°
        if [ $opt_count_col -eq 1 ] && [ -n "$pipe_input" ]; then
            first_line=$(echo "$pipe_input" | head -n1 | xargs 2>/dev/null) || true
            col_count=$(echo "$first_line" | wc -w | tr -d ' \t\n\r')
        fi
        # è¾“å‡ºé€»è¾‘
        if [ $opt_show_raw -eq 2 ]; then
            echo -e "=== ç»Ÿè®¡ç»“æœ ==="
            echo "æ€»è¡Œæ•°: $line_count"
            [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
            echo -e "=== åŸç”Ÿè¾“å‡º ==="
            echo "$pipe_input"
        elif [ $opt_show_raw -eq 1 ]; then
            echo -e "=== åŸç”Ÿè¾“å‡º ==="
            echo "$pipe_input"
            echo -e "=== ç»Ÿè®¡ç»“æœ ==="
            echo "æ€»è¡Œæ•°: $line_count"
            [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
        else
            echo "æ€»è¡Œæ•°: $line_count"
            [ $opt_count_col -eq 1 ] && echo "æ€»åˆ—æ•°: $col_count"
        fi
        exit 0
    fi
}

# è·¯å¾„æ¨¡å¼å¤„ç†ï¼ˆæ ¸å¿ƒï¼šåˆ æ‰æ‰€æœ‰æ˜“æŠ¥é”™çš„è¯­æ³•ï¼Œç”¨æ ‡å‡†[]åˆ¤æ–­ï¼‰
handle_path() {
    local items=()
    # é€šé…ç¬¦å¤„ç†ï¼Œæ ‡å‡†è¯­æ³•
    shopt -s nullglob globstar
    eval "items=($target_path)" 2>/dev/null || true
    shopt -u nullglob globstar

    # æ— åŒ¹é…é¡¹æç¤º
    if [ ${#items[@]} -eq 0 ]; then
        echo -e "âš ï¸  æç¤ºï¼šè·¯å¾„ '$target_path' æ— åŒ¹é…é¡¹æˆ–æ— è®¿é—®æƒé™"
        exit 0
    fi

    # éå†ç»Ÿè®¡ï¼Œå…¨éƒ¨ç”¨æ ‡å‡†[ ]æ¡ä»¶åˆ¤æ–­ï¼Œæ— è¯­æ³•é”™
    for item in "${items[@]}"; do
        # è·³è¿‡ä¸å­˜åœ¨çš„é¡¹
        if [ ! -e "$item" ] && [ ! -L "$item" ]; then
            continue
        fi
        # è¿‡æ»¤éšè—é¡¹
        if [ $opt_no_hidden -eq 1 ]; then
            item_name=$(basename "$item" 2>/dev/null) || true
            if [ "${item_name:0:1}" = "." ]; then
                continue
            fi
        fi
        # ç»Ÿè®¡æ–‡ä»¶ï¼ˆæ™®é€šæ–‡ä»¶+è½¯é“¾æ¥ï¼‰
        if [ -f "$item" ] 2>/dev/null || [ -L "$item" ] 2>/dev/null; then
            file_count=$((file_count + 1))
        # ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆçœŸå®ç›®å½•ï¼Œæ’é™¤è½¯é“¾æ¥ï¼‰
        elif [ -d "$item" ] 2>/dev/null && [ ! -L "$item" ] 2>/dev/null; then
            dir_count=$((dir_count + 1))
        fi
    done

    # è¾“å‡ºç»Ÿè®¡ç»“æœï¼Œæ ‡å‡†è¯­æ³•
    if [ $opt_only_file -eq 1 ]; then
        echo -e "ğŸ“„ ä»…ç»Ÿè®¡æ–‡ä»¶ï¼ˆ$hidden_noteï¼‰: ${color_file}$file_count${color_reset} ä¸ª"
        echo -e "ğŸ“ ç»Ÿè®¡è·¯å¾„: $target_path"
    elif [ $opt_only_dir -eq 1 ]; then
        echo -e "ğŸ“‚ ä»…ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆ$hidden_noteï¼‰: ${color_dir}$dir_count${color_reset} ä¸ª"
        echo -e "ğŸ“ ç»Ÿè®¡è·¯å¾„: $target_path"
    else
        echo -e "ğŸ“Š ç»Ÿè®¡ç»“æœï¼ˆ$hidden_noteï¼‰| è·¯å¾„: $target_path"
        echo -e "â”œâ”€ ğŸ“‚ æ–‡ä»¶å¤¹: ${color_dir}$dir_count${color_reset} ä¸ª"
        echo -e "â””â”€ ğŸ“„ æ–‡ä»¶: ${color_file}$file_count${color_reset} ä¸ª"
    fi
    # è®¡æ•°ä¸º0çš„æç¤º
    if [ $file_count -eq 0 ] && [ $dir_count -eq 0 ]; then
        echo -e "âš ï¸  æç¤ºï¼šæ— ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæˆ–æ— è®¿é—®æƒé™ï¼‰"
    fi
}

# ä¸»é€»è¾‘ï¼ˆæ ‡å‡†è¯­æ³•ï¼Œå…œåº•æŠ¥é”™ï¼‰
main() {
    parse_args "$@" 2>/dev/null || true
    handle_pipe
    handle_path
}

# æ‰§è¡Œä¸»é€»è¾‘ï¼Œæ•è·æ‰€æœ‰æŠ¥é”™
main "$@" 2>/dev/null || {
    echo -e "âŒ æ‰§è¡Œé”™è¯¯ï¼è¯·è¿è¡Œ \`$0 -h\` æŸ¥çœ‹å¸®åŠ©"
    exit 1
}
