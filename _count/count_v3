#!/bin/bash
set -euo pipefail
IFS=$'\n\t'

# åˆå§‹åŒ–å˜é‡ï¼ˆæ‰€æœ‰å˜é‡æ˜¾å¼èµ‹å€¼ï¼Œé¿å…ué€‰é¡¹æŠ¥é”™ï¼‰
opt_show_raw=0          # 0=ä¸æ˜¾ç¤ºåŸç”Ÿè¾“å‡º 1=åº•éƒ¨æ˜¾ç¤º 2=é¡¶éƒ¨æ˜¾ç¤º
opt_count_col=0         # æ˜¯å¦ç»Ÿè®¡åˆ—
opt_only_file=0         # ä»…ç»Ÿè®¡æ–‡ä»¶
opt_only_dir=0          # ä»…ç»Ÿè®¡æ–‡ä»¶å¤¹
opt_no_hidden=0         # è¿‡æ»¤éšè—ç›®å½•/æ–‡ä»¶
target_path=""          # ç›®æ ‡è·¯å¾„/é€šé…ç¬¦
pipe_input=""           # ç®¡é“è¾“å…¥å†…å®¹
hidden_note="å«éšè—"    # éšè—è¯´æ˜é»˜è®¤å€¼
file_count=0            # æ–‡ä»¶è®¡æ•°åˆå§‹åŒ–
dir_count=0             # æ–‡ä»¶å¤¹è®¡æ•°åˆå§‹åŒ–

# å¸®åŠ©ä¿¡æ¯å‡½æ•°
show_help() {
    cat << EOF
ç”¨æ³•: count [é€‰é¡¹] [è·¯å¾„/é€šé…ç¬¦]  æˆ–  å‘½ä»¤ | count [é€‰é¡¹]
åŠŸèƒ½: 1.ç®¡é“ç»Ÿè®¡è¡Œ/åˆ—  2.è·¯å¾„ç»Ÿè®¡æ–‡ä»¶/æ–‡ä»¶å¤¹  3.æ”¯æŒå‚æ•°ç»„åˆ/è°ƒæ¢/é€šé…ç¬¦/éšè—è¿‡æ»¤

### ç®¡é“æ¨¡å¼é€‰é¡¹ï¼ˆå‘½ä»¤ | count [é€‰é¡¹]ï¼‰
  -v, --verbose    æ˜¾ç¤ºåŸç”Ÿè¾“å‡ºï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨åº•éƒ¨
  -V, --VERBOSE    æ˜¾ç¤ºåŸç”Ÿè¾“å‡ºï¼Œç»Ÿè®¡ä¿¡æ¯åœ¨é¡¶éƒ¨
  -c, --col        ç»Ÿè®¡åˆ—æ•°ï¼ˆå¯ä¸-v/Vç»„åˆï¼ŒåŒæ—¶ç»Ÿè®¡è¡Œ+åˆ—ï¼‰

### è·¯å¾„æ¨¡å¼é€‰é¡¹ï¼ˆcount [é€‰é¡¹] è·¯å¾„ï¼‰
  -f, --file       ä»…ç»Ÿè®¡æ–‡ä»¶ï¼ˆä¸åŒ…å«æ–‡ä»¶å¤¹ï¼‰
  -d, --dir        ä»…ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆä¸åŒ…å«æ–‡ä»¶ï¼‰
  -n, --no-hidden  è¿‡æ»¤éšè—ç›®å½•/æ–‡ä»¶ï¼ˆåç§°ä»¥.å¼€å¤´çš„ï¼‰
  æ— ä¸Šè¿°é€‰é¡¹       é»˜è®¤ç»Ÿè®¡ï¼šæ–‡ä»¶+æ–‡ä»¶å¤¹ï¼ˆåŒ…å«éšè—ï¼‰

### é€šç”¨è§„åˆ™
1. å‚æ•°å¯ç»„åˆï¼š-fn = -f -n = -nfï¼Œå¤§å°å†™æ•æ„Ÿï¼ˆ-vâ‰ -Vï¼‰
2. å‚æ•°ä¸è·¯å¾„å¯è°ƒæ¢ï¼šcount -f /home = count /home -f
3. æ”¯æŒé€šé…ç¬¦ï¼šcount /home/*.py  ç»Ÿè®¡.pyç»“å°¾æ–‡ä»¶
4. è·¯å¾„é»˜è®¤å½“å‰ç›®å½•ï¼šcount ç­‰ä»·äº count ./
5. éšè—åˆ¤å®šï¼šåç§°ä»¥.å¼€å¤´ï¼ˆå¦‚.sshã€.bashrcï¼‰ï¼Œ-nä¼šè¿‡æ»¤
6. æƒé™å®¹é”™ï¼šè‡ªåŠ¨è·³è¿‡æ— è¯»æƒé™çš„ç›®å½•/æ–‡ä»¶ï¼Œä¸ç»ˆæ­¢è„šæœ¬

### ç¤ºä¾‹
#### ç®¡é“æ¨¡å¼
ll | count              # ä»…ç»Ÿè®¡llè¾“å‡ºçš„è¡Œæ•°
ll | count -v           # æ˜¾ç¤ºllåŸç”Ÿå†…å®¹ + åº•éƒ¨ç»Ÿè®¡è¡Œæ•°
ls | count -Vc          # æ˜¾ç¤ºlsåŸç”Ÿå†…å®¹ + é¡¶éƒ¨ç»Ÿè®¡è¡Œ+åˆ—
ps aux | count -c       # ä»…ç»Ÿè®¡ps auxè¾“å‡ºçš„åˆ—æ•°

#### è·¯å¾„æ¨¡å¼
count /home             # ç»Ÿè®¡/homeä¸‹æ–‡ä»¶+æ–‡ä»¶å¤¹ï¼ˆå«éšè—ï¼‰
count -f /home          # ä»…ç»Ÿè®¡/homeä¸‹æ–‡ä»¶ï¼ˆå«éšè—ï¼‰
count /home -d -n       # ä»…ç»Ÿè®¡/homeä¸‹ééšè—æ–‡ä»¶å¤¹
count -fn ~/*.sh        # ç»Ÿè®¡å®¶ç›®å½•ä¸‹ééšè—çš„.shè„šæœ¬æ–‡ä»¶
count ./test*           # ç»Ÿè®¡å½“å‰ç›®å½•ä¸‹testå¼€å¤´çš„æ–‡ä»¶/æ–‡ä»¶å¤¹
EOF
    exit 0
}

# è§£æå‘½ä»¤è¡Œå‚æ•°ï¼ˆæ ¸å¿ƒï¼šæ”¯æŒç»„åˆå‚æ•°ã€å‚æ•°è·¯å¾„è°ƒæ¢ï¼‰
parse_args() {
    local args=("$@")
    local path_candidate=""

    # éå†æ‰€æœ‰å‚æ•°ï¼Œå…ˆè§£æé€‰é¡¹ï¼Œæœ€åæå–è·¯å¾„ï¼ˆå…¼å®¹å‚æ•°å’Œè·¯å¾„è°ƒæ¢ï¼‰
    for arg in "${args[@]}"; do
        if [[ "$arg" == --help || "$arg" == -h ]]; then
            show_help
        elif [[ "$arg" == -* ]]; then
            # å¤„ç†é•¿é€‰é¡¹
            if [[ "$arg" == --* ]]; then
                local opt_chars="${arg#--}"
                case "$opt_chars" in
                    verbose) opt_show_raw=1 ;;
                    VERBOSE) opt_show_raw=2 ;;
                    col) opt_count_col=1 ;;
                    file) opt_only_file=1 ;;
                    dir) opt_only_dir=1 ;;
                    no-hidden) opt_no_hidden=1; hidden_note="ééšè—" ;;
                    *) echo "é”™è¯¯ï¼šæœªçŸ¥é•¿é€‰é¡¹ --$opt_chars" >&2; show_help ;;
                esac
            # å¤„ç†çŸ­é€‰é¡¹ï¼ˆç»„åˆå¦‚fnæ‹†åˆ†ä¸ºf nï¼‰
            else
                local opt_chars="${arg#-}"
                for ((i=0; i<${#opt_chars}; i++)); do
                    local c="${opt_chars:$i:1}"
                    case "$c" in
                        v) opt_show_raw=1 ;;
                        V) opt_show_raw=2 ;;
                        c) opt_count_col=1 ;;
                        f) opt_only_file=1 ;;
                        d) opt_only_dir=1 ;;
                        n) opt_no_hidden=1; hidden_note="ééšè—" ;;
                        h) show_help ;;
                        *) echo "é”™è¯¯ï¼šæœªçŸ¥çŸ­é€‰é¡¹ -$c" >&2; show_help ;;
                    esac
                done
            fi
        else
            # æå–è·¯å¾„ï¼ˆå¤šä¸ªè·¯å¾„å–æœ€åä¸€ä¸ªï¼Œå…¼å®¹é€šé…ç¬¦ï¼‰
            path_candidate="$arg"
        fi
    done

    # èµ‹å€¼ç›®æ ‡è·¯å¾„ï¼šæœ‰æŒ‡å®šåˆ™ç”¨æŒ‡å®šï¼Œæ— åˆ™é»˜è®¤å½“å‰ç›®å½•
    target_path=${path_candidate:-"./"}

    # äº’æ–¥é€‰é¡¹æ£€æŸ¥ï¼š-få’Œ-dä¸èƒ½åŒæ—¶ç”¨
    if [[ $opt_only_file -eq 1 && $opt_only_dir -eq 1 ]]; then
        echo "é”™è¯¯ï¼š-f/--file å’Œ -d/--dir ä¸èƒ½åŒæ—¶ä½¿ç”¨ï¼" >&2
        exit 1
    fi
}

# ç®¡é“æ¨¡å¼å¤„ç†ï¼ˆç»Ÿè®¡è¡Œ/åˆ—ï¼Œæ”¯æŒæ˜¾ç¤ºåŸç”Ÿå†…å®¹ï¼‰
handle_pipe() {
    # è¯»å–ç®¡é“è¾“å…¥ï¼ˆå¦‚æœæœ‰ï¼‰
    if [[ ! -t 0 ]]; then
        pipe_input=$(cat - 2>/dev/null) || true
        local line_count=$(echo "$pipe_input" | wc -l | tr -d '[:space:]')
        local col_count=0

        # ç»Ÿè®¡åˆ—æ•°ï¼ˆå–ç¬¬ä¸€è¡Œï¼ŒæŒ‰ç©ºç™½åˆ†å‰²ç»Ÿè®¡ï¼Œå…¼å®¹ls/llçš„åˆ—ï¼‰
        if [[ $opt_count_col -eq 1 && -n "$pipe_input" ]]; then
            local first_line=$(echo "$pipe_input" | head -n1 | xargs 2>/dev/null) || true
            col_count=$(echo "$first_line" | wc -w | tr -d '[:space:]')
        fi

        # æ˜¾ç¤ºåŸç”Ÿå†…å®¹ï¼ˆæŒ‰-v/Vè§„åˆ™ï¼‰
        if [[ $opt_show_raw -eq 2 ]]; then
            # -Vï¼šå…ˆç»Ÿè®¡ï¼Œå†åŸç”Ÿå†…å®¹
            echo -e "=== ç»Ÿè®¡ç»“æœ ==="
            echo "æ€»è¡Œæ•°: $line_count"
            [[ $opt_count_col -eq 1 ]] && echo "æ€»åˆ—æ•°: $col_count"
            echo -e "=== åŸç”Ÿè¾“å‡º ==="
            echo "$pipe_input"
        elif [[ $opt_show_raw -eq 1 ]]; then
            # -vï¼šå…ˆåŸç”Ÿå†…å®¹ï¼Œå†ç»Ÿè®¡
            echo -e "=== åŸç”Ÿè¾“å‡º ==="
            echo "$pipe_input"
            echo -e "=== ç»Ÿè®¡ç»“æœ ==="
            echo "æ€»è¡Œæ•°: $line_count"
            [[ $opt_count_col -eq 1 ]] && echo "æ€»åˆ—æ•°: $col_count"
        else
            # æ— -v/Vï¼šä»…ç»Ÿè®¡
            echo "æ€»è¡Œæ•°: $line_count"
            [[ $opt_count_col -eq 1 ]] && echo "æ€»åˆ—æ•°: $col_count"
        fi
        exit 0
    fi
}

# è·¯å¾„æ¨¡å¼å¤„ç†ï¼ˆæ ¸å¿ƒä¿®å¤ï¼šæƒé™å®¹é”™ã€æ— è¾“å‡ºé—®é¢˜ï¼‰
handle_path() {
    local items=()

    # å…³é”®ä¿®å¤1ï¼šé€šé…ç¬¦å¤„ç†ï¼ˆå•ç‹¬ä½œç”¨åŸŸï¼Œå…¼å®¹ç»å¯¹/ç›¸å¯¹/é€šé…ç¬¦è·¯å¾„ï¼‰
    shopt -s nullglob globstar
    eval "items=($target_path)" 2>/dev/null || true
    shopt -u nullglob globstar

    # å…³é”®ä¿®å¤2ï¼šç©ºæ•°ç»„å®¹é”™ï¼ˆç›´æ¥æç¤ºæ— åŒ¹é…ï¼‰
    if [[ ${#items[@]} -eq 0 ]]; then
        echo -e "âš ï¸  æç¤ºï¼šè·¯å¾„/é€šé…ç¬¦ '$target_path' æ— åŒ¹é…é¡¹æˆ–æ— è®¿é—®æƒé™"
        exit 0
    fi

    # éå†æ‰€æœ‰åŒ¹é…é¡¹ï¼Œç»Ÿè®¡æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæ ¸å¿ƒï¼šæƒé™å®¹é”™ï¼Œè·³è¿‡æ— æƒé™é¡¹ï¼‰
    for item in "${items[@]}"; do
        # ä¿®å¤3ï¼šè·³è¿‡æ— æƒé™/ä¸å­˜åœ¨çš„é¡¹ï¼ˆ2>/dev/nullå±è”½æƒé™æŠ¥é”™ï¼Œ|| trueé¿å…è„šæœ¬é€€å‡ºï¼‰
        if [[ ! -e "$item" && ! -L "$item" ]]; then
            continue
        fi

        # ä¿®å¤4ï¼šè¿‡æ»¤éšè—é¡¹ï¼ˆä»…åˆ¤æ–­æœ€åä¸€çº§åç§°ï¼Œç¬¦åˆLinuxä¹ æƒ¯ï¼‰
        if [[ $opt_no_hidden -eq 1 ]]; then
            local item_name=$(basename "$item" 2>/dev/null) || true
            [[ "$item_name" == .* ]] && continue
        fi

        # ç»Ÿè®¡æ–‡ä»¶ï¼ˆæ™®é€šæ–‡ä»¶ã€è½¯é“¾æ¥ï¼Œå±è”½æƒé™æŠ¥é”™ï¼‰
        if [[ -f "$item" 2>/dev/null || -L "$item" 2>/dev/null ]]; then
            ((file_count++))
        # ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆçœŸå®ç›®å½•ï¼Œæ’é™¤è½¯é“¾æ¥ç›®å½•ï¼Œå±è”½æƒé™æŠ¥é”™ï¼‰
        elif [[ -d "$item" 2>/dev/null && ! -L "$item" 2>/dev/null ]]; then
            ((dir_count++))
        fi
    done

    # å½©è‰²è¾“å‡ºï¼ˆæ–‡ä»¶å¤¹è“ã€æ–‡ä»¶ç»¿ï¼Œä¸å–œæ¬¢å¯åˆ é™¤\033[xxm\033[0mï¼‰
    local color_dir="\033[34m"
    local color_file="\033[32m"
    local color_reset="\033[0m"

    # æ ¹æ®å‚æ•°è¾“å‡ºç»Ÿè®¡ç»“æœï¼ˆç¡®ä¿æ‰€æœ‰åœºæ™¯éƒ½æœ‰è¾“å‡ºï¼‰
    if [[ $opt_only_file -eq 1 ]]; then
        echo -e "ğŸ“„ ä»…ç»Ÿè®¡æ–‡ä»¶ï¼ˆ$hidden_noteï¼‰: ${color_file}$file_count${color_reset} ä¸ª"
        echo -e "ğŸ“ ç»Ÿè®¡è·¯å¾„: $target_path"
    elif [[ $opt_only_dir -eq 1 ]]; then
        echo -e "ğŸ“‚ ä»…ç»Ÿè®¡æ–‡ä»¶å¤¹ï¼ˆ$hidden_noteï¼‰: ${color_dir}$dir_count${color_reset} ä¸ª"
        echo -e "ğŸ“ ç»Ÿè®¡è·¯å¾„: $target_path"
    else
        echo -e "ğŸ“Š ç»Ÿè®¡ç»“æœï¼ˆ$hidden_noteï¼‰| è·¯å¾„: $target_path"
        echo -e "â”œâ”€ ğŸ“‚ æ–‡ä»¶å¤¹: ${color_dir}$dir_count${color_reset} ä¸ª"
        echo -e "â””â”€ ğŸ“„ æ–‡ä»¶: ${color_file}$file_count${color_reset} ä¸ª"
    fi

    # é¢å¤–æç¤ºï¼šè‹¥è®¡æ•°ä¸º0ï¼Œè¯´æ˜åŒ¹é…é¡¹å‡æ— æƒé™/éæ–‡ä»¶/éæ–‡ä»¶å¤¹
    if [[ $file_count -eq 0 && $dir_count -eq 0 ]]; then
        echo -e "âš ï¸  æç¤ºï¼šåŒ¹é…é¡¹ä¸­æ— ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶/æ–‡ä»¶å¤¹ï¼ˆæˆ–æ— è®¿é—®æƒé™ï¼‰"
    fi
}

# ä¸»é€»è¾‘ï¼ˆç¡®ä¿æ‰€æœ‰åˆ†æ”¯éƒ½æœ‰æ‰§è¡Œè·¯å¾„ï¼‰
main() {
    # è§£æå‚æ•°ï¼ˆå±è”½æ— å…³æŠ¥é”™ï¼‰
    parse_args "$@" 2>/dev/null || true
    # å…ˆæ£€æŸ¥ç®¡é“è¾“å…¥ï¼Œä¼˜å…ˆå¤„ç†ç®¡é“æ¨¡å¼
    handle_pipe
    # æ— ç®¡é“åˆ™å¤„ç†è·¯å¾„æ¨¡å¼ï¼ˆæœ€ç»ˆå…œåº•ï¼Œç¡®ä¿æœ‰è¾“å‡ºï¼‰
    handle_path
}

# æ‰§è¡Œä¸»é€»è¾‘ï¼ˆæ•è·æ‰€æœ‰é¡¶å±‚æŠ¥é”™ï¼Œé¿å…æ— è¾“å‡ºï¼‰
main "$@" 2>/dev/null || {
    echo -e "âŒ æ‰§è¡Œé”™è¯¯ï¼è¯·æ‰§è¡Œ \`$0 -h\` æŸ¥çœ‹æ­£ç¡®ç”¨æ³•"
    exit 1
}
